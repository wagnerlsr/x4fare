package br.com.x4fare.services.impl;

import br.com.x4fare.X4FareApplication;
import br.com.x4fare.services.BusStopService;
import br.com.x4fare.services.http.HttpService;
import com.jayway.jsonpath.JsonPath;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.HashMap;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.when;


@ActiveProfiles("test")
@RunWith(SpringRunner.class)
@SpringBootTest(classes = X4FareApplication.class)
class BusStopServiceImplTests {

    @MockBean(name="httpService")
    HttpService httpService;
    BusStopService busStopService;

    @BeforeEach
    public void setUp() {
        busStopService = new BusStopServiceImpl(httpService);
    }

    @Test
    public void stopTimetables_Success() {

        var response = "{\"id\":\"https://transportapi.com/v3/uk/bus/stop_timetables/450024834.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"atcocode\":\"450024834\",\"smscode\":\"45024834\",\"request_time\":\"2024-04-28T19:35:50+01:00\",\"name\":\"Station C\",\"stop_name\":\"Station C\",\"bearing\":\"SE\",\"indicator\":null,\"locality\":\"Leeds City Centre, Leeds\",\"location\":{\"type\":\"Point\",\"coordinates\":[-1.54652,53.79607]},\"departures\":{\"all\":[{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7A/outbound/450024834/2024-04-28/19:40/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7A\",\"line_name\":\"7A\",\"dir\":\"outbound\",\"direction\":\"Alwoodley\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"19:40\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"19:40\"}},\"best_departure_estimate\":\"19:40\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7A/outbound/450024834/2024-04-28/19:40/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7A\",\"line_name\":\"7A\",\"dir\":\"outbound\",\"direction\":\"Alwoodley\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"19:40\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"19:40\"}},\"best_departure_estimate\":\"19:40\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7S/outbound/450024834/2024-04-28/20:00/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7S\",\"line_name\":\"7S\",\"dir\":\"outbound\",\"direction\":\"Shadwell\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:00\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:00\"}},\"best_departure_estimate\":\"20:00\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7S/outbound/450024834/2024-04-28/20:00/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7S\",\"line_name\":\"7S\",\"dir\":\"outbound\",\"direction\":\"Shadwell\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:00\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:00\"}},\"best_departure_estimate\":\"20:00\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7/outbound/450024834/2024-04-28/20:20/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7\",\"line_name\":\"7\",\"dir\":\"outbound\",\"direction\":\"Primley Park\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:20\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:20\"}},\"best_departure_estimate\":\"20:20\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7/outbound/450024834/2024-04-28/20:20/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7\",\"line_name\":\"7\",\"dir\":\"outbound\",\"direction\":\"Primley Park\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:20\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:20\"}},\"best_departure_estimate\":\"20:20\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLYE/A1/outbound/450024834/2024-04-28/20:27/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"A1\",\"line_name\":\"A1\",\"dir\":\"outbound\",\"direction\":\"Leeds\",\"operator\":\"FLYE\",\"operator_name\":\"Flyer\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:27\",\"aimed\":{\"arrival\":{\"date\":\"2024-04-28\",\"time\":\"20:27\"},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:27\"}},\"best_departure_estimate\":\"20:27\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7A/outbound/450024834/2024-04-28/20:40/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7A\",\"line_name\":\"7A\",\"dir\":\"outbound\",\"direction\":\"Alwoodley\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:40\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:40\"}},\"best_departure_estimate\":\"20:40\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7A/outbound/450024834/2024-04-28/20:40/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7A\",\"line_name\":\"7A\",\"dir\":\"outbound\",\"direction\":\"Alwoodley\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"20:40\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"20:40\"}},\"best_departure_estimate\":\"20:40\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7S/outbound/450024834/2024-04-28/21:00/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7S\",\"line_name\":\"7S\",\"dir\":\"outbound\",\"direction\":\"Shadwell\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"21:00\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"21:00\"}},\"best_departure_estimate\":\"21:00\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7S/outbound/450024834/2024-04-28/21:00/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7S\",\"line_name\":\"7S\",\"dir\":\"outbound\",\"direction\":\"Shadwell\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"21:00\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"21:00\"}},\"best_departure_estimate\":\"21:00\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7/outbound/450024834/2024-04-28/21:20/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7\",\"line_name\":\"7\",\"dir\":\"outbound\",\"direction\":\"Primley Park\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"21:20\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"21:20\"}},\"best_departure_estimate\":\"21:20\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLDS/7/outbound/450024834/2024-04-28/21:20/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"7\",\"line_name\":\"7\",\"dir\":\"outbound\",\"direction\":\"Primley Park\",\"operator\":\"FLDS\",\"operator_name\":\"First Leeds\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"21:20\",\"aimed\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"21:20\"}},\"best_departure_estimate\":\"21:20\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}},{\"id\":\"https://transportapi.com/v3/uk/bus/route/FLYE/A1/outbound/450024834/2024-04-28/21:27/timetable.json?app_id=ee9dddff\\u0026app_key=6b6193e54d358084bd4fd58ecb9ed1b7\",\"mode\":\"bus\",\"line\":\"A1\",\"line_name\":\"A1\",\"dir\":\"outbound\",\"direction\":\"Leeds\",\"operator\":\"FLYE\",\"operator_name\":\"Flyer\",\"date\":\"2024-04-28\",\"aimed_departure_time\":\"21:27\",\"aimed\":{\"arrival\":{\"date\":\"2024-04-28\",\"time\":\"21:27\"},\"departure\":{\"date\":\"2024-04-28\",\"time\":\"21:27\"}},\"best_departure_estimate\":\"21:27\",\"source\":\"tnds\",\"expected_departure_date\":null,\"expected_departure_time\":null,\"expected\":{\"arrival\":{\"date\":null,\"time\":null},\"departure\":{\"date\":null,\"time\":null}}}]}}";

        when( httpService.getStopTimetables(anyString()) ).thenReturn(response);

        var result = busStopService.stopTimetables("450024834.json");

        var departures = JsonPath.parse(result).read("$.Departures");
        var line = JsonPath.parse(result).read("$.Departures[0].Line");
        var destination = JsonPath.parse(result).read("$.Departures[0].Destination");
        var time = JsonPath.parse(result).read("$.Departures[0].Time");

        assertThat( result ).isNotNull();
        assertThat( result ).isInstanceOf(HashMap.class);
        assertThat( departures ).isInstanceOf(List.class);
        assertThat( line ).isEqualTo("7A");
        assertThat( destination ).isEqualTo("Alwoodley");
        assertThat( time ).isEqualTo("19:40");

    }

}
